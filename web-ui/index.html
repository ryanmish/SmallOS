<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SmallTV</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}

:root{
  --bg:#f2f1ed;
  --surface:#faf9f7;
  --surface2:#efede8;
  --border:rgba(90,80,65,.1);
  --text:#3a3428;
  --text2:#78705f;
  --text3:#a59d8e;
  --accent:#7e9462;
  --accent-hover:#6e8354;
  --accent-dim:rgba(126,148,98,.1);
  --accent-dim2:rgba(126,148,98,.18);
  --danger:#bf5f55;
  --danger-dim:rgba(191,95,85,.08);
  --radius:16px;
  --radius-sm:11px;
  --shadow:0 1px 3px rgba(100,90,70,.06), 0 4px 12px rgba(100,90,70,.04);
  --shadow-hover:0 2px 8px rgba(100,90,70,.1), 0 6px 20px rgba(100,90,70,.06);
}

body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
  max-width:460px;
  margin:0 auto;
  padding:0 0 32px;
  font-size:16px;
  line-height:1.5;
  min-height:100vh;
  -webkit-font-smoothing:antialiased;
}

/* ---- Top bar (header + tabs) ---- */
.top-bar{
  display:flex;
  align-items:center;
  padding:20px 20px 0;
  position:sticky;
  top:0;
  background:var(--bg);
  z-index:50;
  border-bottom:1px solid var(--border);
}
.top-left{
  display:flex;
  align-items:center;
  gap:8px;
  margin-right:auto;
}
.top-left h1{
  font-size:1.2em;
  font-weight:800;
  color:var(--text);
  letter-spacing:-.2px;
}
.top-left .dot{
  width:8px;height:8px;
  border-radius:50%;
  background:var(--text3);
  flex-shrink:0;
  transition:background .3s;
}
.top-left .dot.online{
  background:var(--accent);
  box-shadow:0 0 0 3px var(--accent-dim);
  animation:pulse 2.5s ease-in-out infinite;
}
@keyframes pulse{
  0%,100%{box-shadow:0 0 0 3px var(--accent-dim)}
  50%{box-shadow:0 0 0 6px var(--accent-dim)}
}
.tab-bar{
  display:flex;
  gap:2px;
}
.tab-btn{
  padding:12px 14px 14px;
  background:none;
  border:none;
  color:var(--text3);
  font-size:.85em;
  font-weight:700;
  letter-spacing:.3px;
  cursor:pointer;
  position:relative;
  transition:color .2s;
  text-transform:uppercase;
}
.tab-btn:hover{color:var(--text2)}
.tab-btn.active{color:var(--accent)}
.tab-btn.active::after{
  content:'';
  position:absolute;
  bottom:0;left:10%;right:10%;
  height:2px;
  background:var(--accent);
  border-radius:2px 2px 0 0;
}

/* ---- Content ---- */
.tab-content{
  display:none;
  padding:24px 20px 0;
  flex:1;
  animation:fadeIn .25s ease;
}
.tab-content.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* ---- Section (cards) ---- */
.section{
  background:var(--surface);
  border-radius:var(--radius);
  padding:20px;
  margin-bottom:14px;
  box-shadow:var(--shadow);
  border:1px solid var(--border);
}
.section:last-child{margin-bottom:0}
.section-title{
  font-size:.75em;
  color:var(--text3);
  text-transform:uppercase;
  letter-spacing:1.6px;
  font-weight:700;
  margin-bottom:16px;
}

/* ---- Status rows ---- */
.status-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 0;
  border-bottom:1px solid var(--border);
}
.status-row:last-child{border-bottom:none}
.status-label{color:var(--text2);font-size:.95em}
.status-value{color:var(--text);font-size:.95em;font-weight:600}
.badge{
  display:inline-block;
  background:var(--accent-dim);
  color:var(--accent);
  padding:3px 10px;
  border-radius:20px;
  font-size:.78em;
  font-weight:600;
}

/* ---- Inputs ---- */
label{
  display:block;
  font-size:.88em;
  color:var(--text2);
  margin-bottom:6px;
  font-weight:600;
  letter-spacing:.2px;
}
input[type=text],input[type=password],input[type=number],select{
  width:100%;
  padding:11px 14px;
  background:#f5f4f1;
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  color:var(--text);
  font-size:.9em;
  font-family:inherit;
  margin-bottom:12px;
  transition:border-color .2s,box-shadow .2s;
  outline:none;
  appearance:none;
  -webkit-appearance:none;
}
select{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='7'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23847a6d' stroke-width='1.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 14px center;
  background-color:var(--surface2);
  padding-right:36px;
  cursor:pointer;
}
input:focus,select:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px var(--accent-dim);
}
input::placeholder{color:var(--text3)}

/* ---- Range slider ---- */
input[type=range]{
  -webkit-appearance:none;
  width:100%;
  margin:6px 0 4px;
  background:transparent;
  outline:none;
}
input[type=range]::-webkit-slider-runnable-track{
  height:6px;
  background:var(--surface2);
  border-radius:3px;
  border:1px solid var(--border);
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;
  width:22px;height:22px;
  border-radius:50%;
  background:var(--accent);
  margin-top:-9px;
  cursor:pointer;
  box-shadow:0 1px 4px rgba(0,0,0,.15);
  transition:transform .15s,box-shadow .15s;
  border:2px solid #fff;
}
input[type=range]::-webkit-slider-thumb:hover{
  transform:scale(1.12);
  box-shadow:0 2px 8px rgba(126,148,98,.3);
}
input[type=range]:active::-webkit-slider-thumb{transform:scale(1.05)}
.range-row{
  display:flex;
  align-items:center;
  gap:14px;
}
.range-row input[type=range]{flex:1}
.range-val{
  font-size:.85em;
  font-weight:700;
  color:var(--text);
  min-width:38px;
  text-align:right;
  font-variant-numeric:tabular-nums;
}

/* ---- Buttons ---- */
button{
  padding:11px 20px;
  border:none;
  border-radius:var(--radius-sm);
  cursor:pointer;
  font-size:.88em;
  font-family:inherit;
  font-weight:600;
  transition:all .15s ease;
  min-height:44px;
}
button:active{transform:scale(.97)}
.btn{
  background:var(--accent);
  color:#fff;
  box-shadow:0 2px 6px rgba(126,148,98,.2);
}
.btn:hover{
  background:var(--accent-hover);
  box-shadow:0 3px 10px rgba(126,148,98,.28);
}
.btn-sec{
  background:var(--surface2);
  color:var(--text2);
  border:1px solid var(--border);
}
.btn-sec:hover{background:#dfdcd6;color:var(--text)}
.btn-warn{
  background:var(--danger-dim);
  color:var(--danger);
  border:1px solid rgba(191,95,85,.15);
}
.btn-warn:hover{background:rgba(191,95,85,.14)}
.btn-block{width:100%;margin-top:4px}

/* ---- Toggle (F/C) ---- */
.toggle{display:flex;gap:0;margin-bottom:12px}
.toggle button{
  flex:1;
  padding:9px;
  border:1px solid var(--border);
  background:var(--surface2);
  color:var(--text3);
  min-height:40px;
  transition:all .2s;
  font-weight:500;
  box-shadow:none;
}
.toggle button:first-child{border-radius:var(--radius-sm) 0 0 var(--radius-sm)}
.toggle button:last-child{border-radius:0 var(--radius-sm) var(--radius-sm) 0;border-left:none}
.toggle button:hover{color:var(--text2);transform:none}
.toggle button:active{transform:none}
.toggle button.active{
  background:var(--accent);
  color:#fff;
  border-color:var(--accent);
  font-weight:700;
  box-shadow:inset 0 1px 2px rgba(0,0,0,.1);
}

/* ---- Switch toggle ---- */
.switch-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:8px 0;
}
.switch-row .switch-label{
  font-size:.92em;
  color:var(--text);
  font-weight:500;
}
.switch{
  position:relative;
  width:46px;
  height:28px;
  flex-shrink:0;
}
.switch input{opacity:0;width:0;height:0}
.switch-track{
  position:absolute;
  inset:0;
  background:var(--surface2);
  border:1px solid var(--border);
  border-radius:14px;
  cursor:pointer;
  transition:background .2s,border-color .2s;
}
.switch-track::after{
  content:'';
  position:absolute;
  top:3px;left:3px;
  width:20px;height:20px;
  background:#fff;
  border-radius:50%;
  transition:transform .2s,box-shadow .2s;
  box-shadow:0 1px 3px rgba(0,0,0,.12);
}
.switch input:checked+.switch-track{
  background:var(--accent);
  border-color:var(--accent);
}
.switch input:checked+.switch-track::after{
  transform:translateX(18px);
  background:#fff;
  box-shadow:0 1px 3px rgba(0,0,0,.15);
}

/* ---- WiFi networks ---- */
.net-list{margin:10px 0}
.net{
  padding:12px 14px;
  margin:0 0 6px;
  border-radius:var(--radius-sm);
  background:var(--surface2);
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
  transition:all .15s ease;
  border:2px solid transparent;
}
.net:hover{
  background:#e2dfda;
  transform:translateY(-1px);
  box-shadow:0 2px 6px rgba(100,90,70,.08);
}
.net.selected{
  border-color:var(--accent);
  background:var(--accent-dim);
}
.net-name{font-size:.95em;font-weight:500}
.net-name .lock{margin-left:5px;opacity:.4;vertical-align:-1px;display:inline-block}
.rssi{color:var(--text3);font-size:.85em;font-family:monospace;white-space:nowrap}
.bars{letter-spacing:1px;margin-right:4px;font-size:.9em}

.selected-net{
  padding:14px;
  background:var(--accent-dim2);
  border:1px solid var(--accent-dim2);
  border-radius:var(--radius-sm);
  margin-bottom:12px;
  display:flex;
  align-items:center;
  gap:8px;
}
.selected-net-label{font-size:.72em;color:var(--accent);font-weight:700;text-transform:uppercase;letter-spacing:.8px}
.selected-net-name{font-size:.95em;font-weight:600;color:var(--text)}
.manual-link{
  font-size:.8em;
  color:var(--accent);
  cursor:pointer;
  text-decoration:none;
  display:inline-block;
  margin-bottom:10px;
  font-weight:500;
  opacity:.8;
  transition:opacity .15s;
}
.manual-link:hover{opacity:1}

/* ---- Night mode time pickers ---- */
.time-row{
  display:flex;
  gap:12px;
  margin-bottom:12px;
}
.time-row .time-col{flex:1}
.time-row label{margin-bottom:4px}

/* ---- Toast ---- */
#msg{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  width:calc(100% - 40px);
  max-width:420px;
  padding:12px 16px;
  border-radius:var(--radius-sm);
  display:none;
  font-size:.88em;
  font-weight:500;
  z-index:200;
  box-shadow:0 4px 16px rgba(0,0,0,.08);
  animation:slideUp .25s ease;
}
@keyframes slideUp{from{opacity:0;transform:translateX(-50%) translateY(10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.ok{background:#f2f8ee;color:#4a7a3a;border:1px solid rgba(126,148,98,.2)}
.err{background:#fdf2f1;color:var(--danger);border:1px solid rgba(191,95,85,.15)}

/* ---- OTA status ---- */
.ota-badge{
  font-size:.58em;
  font-weight:700;
  padding:2px 8px;
  border-radius:20px;
  text-transform:uppercase;
  letter-spacing:.5px;
}
.ota-badge.confirmed{background:var(--accent-dim);color:var(--accent)}
.ota-badge.pending{background:rgba(200,160,40,.12);color:#a08620}
.ota-actions{
  display:flex;
  gap:8px;
  margin-top:10px;
}
.btn-sm{
  flex:1;
  padding:7px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-size:.78em;
  font-family:inherit;
  font-weight:600;
  transition:all .15s ease;
  min-height:34px;
}
.btn-sm:active{transform:scale(.97)}
.btn-confirm{
  background:var(--accent);
  color:#fff;
  box-shadow:0 1px 4px rgba(126,148,98,.2);
}
.btn-confirm:hover{background:var(--accent-hover)}
.btn-confirm.are-you-sure{
  background:#c49a20;
  box-shadow:0 1px 4px rgba(196,154,32,.25);
}
.btn-confirm.are-you-sure:hover{background:#b08a18}
.btn-rollback{
  background:var(--danger-dim);
  color:var(--danger);
  border:1px solid rgba(191,95,85,.15);
}
.btn-rollback:hover{background:rgba(191,95,85,.14)}
.btn-rollback.are-you-sure{
  background:var(--danger);
  color:#fff;
  border-color:var(--danger);
}
.btn-rollback.are-you-sure:hover{background:#a8504a}

/* ---- OTA timer ---- */
.ota-timer{margin:14px 0 0}
.ota-timer-bar{height:4px;background:#efede8;border-radius:2px;overflow:hidden}
.ota-timer-fill{height:100%;background:linear-gradient(90deg,var(--accent),#c49a20,var(--danger));border-radius:2px;transition:width 1s linear}
.ota-timer-text{font-size:.75em;color:var(--text3);margin-top:2px;text-align:center}
.ota-spinner{display:inline-block;width:12px;height:12px;border:2px solid var(--surface2);border-top-color:var(--accent);border-radius:50%;animation:otaSpin 1.5s linear infinite;vertical-align:-1px;margin-left:5px}
@keyframes otaSpin{to{transform:rotate(360deg)}}

/* ---- Divider ---- */
.divider{height:1px;background:var(--border);margin:4px 0}

/* ---- Device info (system) ---- */
.info-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.info-cell{
  padding:14px;
  background:var(--surface2);
  border-radius:var(--radius-sm);
}
.info-cell .info-label{
  font-size:.68em;
  text-transform:uppercase;
  letter-spacing:1px;
  color:var(--text3);
  margin-bottom:4px;
  font-weight:700;
}
.info-cell .info-value{
  font-size:.92em;
  font-weight:700;
  color:var(--text);
  font-variant-numeric:tabular-nums;
}
</style>
</head><body>

<div class="top-bar">
  <div class="top-left">
    <h1>SmallTV</h1>
    <div class="dot" id="status-dot"></div>
  </div>
  <div class="tab-bar">
    <button class="tab-btn active" data-tab="home" onclick="switchTab('home')">Home</button>
    <button class="tab-btn" data-tab="settings" onclick="switchTab('settings')">Settings</button>
    <button class="tab-btn" data-tab="system" onclick="switchTab('system')">System</button>
  </div>
</div>

<div id="msg"></div>

<!-- ==================== HOME TAB ==================== -->
<div class="tab-content active" id="tab-home">

  <div class="section">
    <div class="section-title">Status</div>
    <div class="status-row"><span class="status-label">WiFi</span><span class="status-value" id="s-wifi">--</span></div>
    <div class="status-row"><span class="status-label">IP Address</span><span class="status-value" id="s-ip">--</span></div>
    <div class="status-row"><span class="status-label">Signal</span><span class="status-value" id="s-rssi">--</span></div>
  </div>

  <div class="section">
    <div class="section-title">WiFi Network</div>
    <button class="btn-sec btn-block" onclick="doScan()" id="scan-btn">Scan Networks</button>
    <div class="net-list" id="nets"></div>

    <div id="selected-net-box" style="display:none">
      <div class="selected-net">
        <div>
          <div class="selected-net-label">Selected network</div>
          <div class="selected-net-name" id="selected-net-name"></div>
        </div>
      </div>
    </div>

    <div id="manual-entry-row">
      <a class="manual-link" id="manual-toggle" onclick="toggleManualSSID()">Enter SSID manually</a>
      <div id="manual-ssid-wrap" style="display:none">
        <input type="text" id="w-ssid" placeholder="Network name">
      </div>
    </div>

    <label>Password</label>
    <input type="password" id="w-pass" placeholder="Enter password">
    <button class="btn btn-block" onclick="doConnect()">Connect</button>
  </div>
</div>

<!-- ==================== SETTINGS TAB ==================== -->
<div class="tab-content" id="tab-settings">

  <div class="section">
    <div class="section-title">Display</div>
    <label>Brightness</label>
    <div class="range-row">
      <input type="range" id="brt" min="0" max="100" oninput="document.getElementById('brt-val').textContent=this.value+'%'" onchange="setParam('brt',this.value)">
      <span class="range-val" id="brt-val">--</span>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Temperature</div>
    <div class="toggle">
      <button id="btn-f" onclick="setUnit(true)">&#176;F</button>
      <button id="btn-c" onclick="setUnit(false)">&#176;C</button>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Timezone</div>
    <select id="gmt" onchange="setParam('gmt',this.value)">
      <option value="-18000">US Eastern (UTC-5)</option>
      <option value="-21600">US Central (UTC-6)</option>
      <option value="-25200">US Mountain (UTC-7)</option>
      <option value="-28800">US Pacific (UTC-8)</option>
      <option value="0">UTC</option>
    </select>
  </div>

  <div class="section">
    <div class="section-title">Location</div>
    <label>Latitude</label>
    <input type="number" id="lat" step="0.0001" placeholder="e.g. 40.7128">
    <label>Longitude</label>
    <input type="number" id="lon" step="0.0001" placeholder="e.g. -74.0060">
    <button class="btn btn-block" onclick="setLoc()">Save Location</button>
  </div>

  <div class="section">
    <div class="section-title">Night Mode</div>
    <div class="switch-row">
      <span class="switch-label">Enable night mode</span>
      <label class="switch">
        <input type="checkbox" id="night-on" onchange="setParam('nightOn',this.checked?1:0)">
        <span class="switch-track"></span>
      </label>
    </div>
    <div id="night-options">
      <div class="time-row">
        <div class="time-col">
          <label>Start hour</label>
          <select id="night-start" onchange="setParam('nightStart',this.value)"></select>
        </div>
        <div class="time-col">
          <label>End hour</label>
          <select id="night-end" onchange="setParam('nightEnd',this.value)"></select>
        </div>
      </div>
      <label>Night brightness</label>
      <div class="range-row">
        <input type="range" id="night-brt" min="0" max="100" value="0" oninput="document.getElementById('night-brt-val').textContent=this.value+'%'" onchange="setParam('nightBrt',this.value)">
        <span class="range-val" id="night-brt-val">0%</span>
      </div>
    </div>
  </div>
</div>

<!-- ==================== SYSTEM TAB ==================== -->
<div class="tab-content" id="tab-system">

  <div class="section">
    <div class="section-title">Device Info</div>
    <div class="info-grid">
      <div class="info-cell">
        <div class="info-label">Firmware</div>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="info-value" id="s-ver">--</div>
          <span class="ota-badge" id="ota-badge"></span>
        </div>
      </div>
      <div class="info-cell">
        <div class="info-label">MAC Address</div>
        <div class="info-value" id="s-mac">--</div>
      </div>
      <div class="info-cell">
        <div class="info-label">Free Heap</div>
        <div class="info-value" id="s-heap">--</div>
      </div>
      <div class="info-cell">
        <div class="info-label">Uptime</div>
        <div class="info-value" id="s-up">--</div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Firmware</div>
    <button class="btn-sec btn-block" onclick="location.href=API+'/update'">Upload Firmware</button>
    <div id="ota-pending-wrap" style="display:none">
      <div class="ota-actions">
        <button class="btn-sm btn-confirm" id="ota-confirm-btn" onclick="otaConfirm()">Confirm Good</button>
        <button class="btn-sm btn-rollback" id="ota-rollback-btn" onclick="otaRollback()">Roll Back</button>
      </div>
      <div class="ota-timer">
        <div class="ota-timer-bar"><div class="ota-timer-fill" id="ota-timer-fill"></div></div>
        <div class="ota-timer-text" id="ota-timer-text"></div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Reset</div>
    <button class="btn-warn btn-block" id="rst-btn" onclick="confirmReset()">Factory Reset</button>
  </div>
</div>

<script>
// *** DEVELOPMENT: Set this to your device IP. Set to '' for production (embedded). ***
var API = 'http://192.168.86.250';

var selectedSSID = '';
var otaCountdown = null;
var otaRemaining = 0;

// ---- Tabs ----
function switchTab(name) {
  var tabs = document.querySelectorAll('.tab-btn');
  var panels = document.querySelectorAll('.tab-content');
  for (var i = 0; i < tabs.length; i++) {
    tabs[i].className = tabs[i].getAttribute('data-tab') === name ? 'tab-btn active' : 'tab-btn';
  }
  for (var i = 0; i < panels.length; i++) {
    panels[i].className = panels[i].id === 'tab-' + name ? 'tab-content active' : 'tab-content';
  }
}

// ---- Toast ----
function msg(t, ok) {
  var m = document.getElementById('msg');
  m.textContent = t;
  m.className = ok ? 'ok' : 'err';
  m.style.display = 'block';
  setTimeout(function() { m.style.display = 'none'; }, 3500);
}

// ---- Helpers ----
function esc(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function api(u, o) { return fetch(API + u, o).then(function(r) { return r.json(); }).catch(function(e) { msg('Request failed', ''); }); }
function rssiToBars(r) {
  if (r >= -50) return '\u2582\u2584\u2586\u2588';
  if (r >= -65) return '\u2582\u2584\u2586';
  if (r >= -80) return '\u2582\u2584';
  return '\u2582';
}

function formatHour(h) {
  if (h === 0) return '12 AM';
  if (h < 12) return h + ' AM';
  if (h === 12) return '12 PM';
  return (h - 12) + ' PM';
}

// ---- Populate night mode hour dropdowns ----
(function() {
  var startSel = document.getElementById('night-start');
  var endSel = document.getElementById('night-end');
  for (var i = 0; i < 24; i++) {
    var label = formatHour(i);
    startSel.innerHTML += '<option value="' + i + '">' + label + '</option>';
    endSel.innerHTML += '<option value="' + i + '">' + label + '</option>';
  }
  startSel.value = '22';
  endSel.value = '7';
})();

// ---- Load status ----
function load() {
  api('/api/status').then(function(d) {
    if (!d) return;

    // Status dot
    var dot = document.getElementById('status-dot');
    if (d.ssid && d.ip) dot.className = 'dot online';

    // Home tab
    document.getElementById('s-wifi').textContent = d.ssid || 'Not connected';
    document.getElementById('s-ip').textContent = d.ip || '--';
    if (d.rssi != null) {
      document.getElementById('s-rssi').innerHTML = '<span class="bars">' + rssiToBars(d.rssi) + '</span> ' + d.rssi + ' dBm';
    }

    // System tab
    if (d.version) document.getElementById('s-ver').textContent = d.version;
    // OTA status
    var badge = document.getElementById('ota-badge');
    var pendingWrap = document.getElementById('ota-pending-wrap');
    if (d.ota_confirmed != null) {
      if (d.ota_confirmed) {
        badge.textContent = 'Confirmed';
        badge.className = 'ota-badge confirmed';
        pendingWrap.style.display = 'none';
        stopOtaTimer();
      } else {
        badge.textContent = 'Unconfirmed';
        badge.className = 'ota-badge pending';
        pendingWrap.style.display = 'block';
        startOtaTimer(120 - (d.uptime || 0));
      }
    }
    if (d.mac) document.getElementById('s-mac').textContent = d.mac;
    document.getElementById('s-heap').textContent = d.heap ? Math.round(d.heap / 1024) + ' KB' : '--';
    var u = d.uptime || 0;
    var h = Math.floor(u / 3600);
    var m = Math.floor((u % 3600) / 60);
    document.getElementById('s-up').textContent = h + 'h ' + m + 'm';

    // Settings: brightness
    if (d.brightness != null) {
      document.getElementById('brt').value = d.brightness;
      document.getElementById('brt-val').textContent = d.brightness + '%';
    }

    // Settings: timezone
    if (d.gmt_offset != null) {
      var gmtSel = document.getElementById('gmt');
      var val = String(d.gmt_offset);
      for (var i = 0; i < gmtSel.options.length; i++) {
        if (gmtSel.options[i].value === val) { gmtSel.value = val; break; }
      }
    }

    // Settings: temp unit
    if (d.temp_f != null) {
      document.getElementById('btn-f').className = d.temp_f ? 'active' : '';
      document.getElementById('btn-c').className = d.temp_f ? '' : 'active';
    }

    // Settings: location
    if (d.lat != null) document.getElementById('lat').value = d.lat;
    if (d.lon != null) document.getElementById('lon').value = d.lon;

    // Settings: night mode
    if (d.night_on != null) {
      document.getElementById('night-on').checked = !!d.night_on;
    }
    if (d.night_start != null) {
      document.getElementById('night-start').value = d.night_start;
    }
    if (d.night_end != null) {
      document.getElementById('night-end').value = d.night_end;
    }
    if (d.night_brt != null) {
      document.getElementById('night-brt').value = d.night_brt;
      document.getElementById('night-brt-val').textContent = d.night_brt + '%';
    }
  });
}

// ---- WiFi scanning ----
function showNets(d) {
  if (!d || !d.networks || !d.networks.length) {
    document.getElementById('nets').innerHTML = '<div style="padding:14px 0;color:var(--text3);font-size:.9em">No networks found</div>';
    return;
  }
  var h = '';
  d.networks.forEach(function(n) {
    var s = esc(n.ssid);
    var bars = rssiToBars(n.rssi);
    var safeName = s.replace(/'/g, '&#39;').replace(/\\/g, '\\\\');
    h += '<div class="net" onclick="selectNetwork(\'' + safeName + '\')" id="net-' + safeName.replace(/[^a-zA-Z0-9]/g, '_') + '">';
    h += '<span class="net-name">' + s + (n.enc ? '<span class="lock"><svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="currentColor" viewBox="0 0 256 256"><path d="M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80ZM96,56a32,32,0,0,1,64,0V80H96Z"></path></svg></span>' : '') + '</span>';
    h += '<span class="rssi"><span class="bars">' + bars + '</span> ' + n.rssi + ' dBm</span>';
    h += '</div>';
  });
  document.getElementById('nets').innerHTML = h;
}

function selectNetwork(ssid) {
  selectedSSID = ssid;

  // Update hidden ssid field
  document.getElementById('w-ssid').value = ssid;

  // Update visual selection
  var nets = document.querySelectorAll('.net');
  for (var i = 0; i < nets.length; i++) nets[i].classList.remove('selected');
  var safeId = 'net-' + ssid.replace(/'/g, '&#39;').replace(/[^a-zA-Z0-9]/g, '_');
  var el = document.getElementById(safeId);
  if (el) el.classList.add('selected');

  // Show selected network name
  document.getElementById('selected-net-name').textContent = ssid;
  document.getElementById('selected-net-box').style.display = 'block';

  // Hide manual entry if showing
  document.getElementById('manual-ssid-wrap').style.display = 'none';
  document.getElementById('manual-toggle').textContent = 'Enter SSID manually';

  // Focus password field
  document.getElementById('w-pass').focus();
}

function toggleManualSSID() {
  var wrap = document.getElementById('manual-ssid-wrap');
  var link = document.getElementById('manual-toggle');
  if (wrap.style.display === 'none') {
    wrap.style.display = 'block';
    link.textContent = 'Hide manual entry';
    document.getElementById('w-ssid').focus();
    // Clear network selection
    selectedSSID = '';
    document.getElementById('selected-net-box').style.display = 'none';
    var nets = document.querySelectorAll('.net');
    for (var i = 0; i < nets.length; i++) nets[i].classList.remove('selected');
  } else {
    wrap.style.display = 'none';
    link.textContent = 'Enter SSID manually';
  }
}

function doScan() {
  var btn = document.getElementById('scan-btn');
  btn.textContent = 'Scanning\u2026';
  btn.disabled = true;
  document.getElementById('nets').innerHTML = '';
  api('/api/scan?start=1').then(function() {
    var tries = 0;
    var poll = setInterval(function() {
      api('/api/scan').then(function(d) {
        if (d && !d.scanning) { clearInterval(poll); btn.textContent = 'Scan Networks'; btn.disabled = false; showNets(d); }
        else if (++tries > 20) { clearInterval(poll); btn.textContent = 'Scan Networks'; btn.disabled = false; showNets(d); }
      });
    }, 500);
  });
}

function doConnect() {
  var s = selectedSSID || document.getElementById('w-ssid').value;
  var p = document.getElementById('w-pass').value;
  if (!s) { msg('Select a network or enter SSID', ''); return; }
  msg('Connecting\u2026', true);
  fetch(API + '/api/connect', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ssid: s, password: p })
  }).then(function(r) { return r.json(); })
    .then(function(d) {
      msg(d.message || 'Sent', d.success);
      if (d.success) setTimeout(function() { location.reload(); }, 5000);
    }).catch(function() { msg('Failed', ''); });
}

// ---- Settings ----
function setParam(k, v) {
  api('/api/set?' + k + '=' + v).then(function(d) {
    if (d && d.success) msg('Saved', true);
    else msg('Failed', '');
  });
}

function setUnit(f) {
  fetch(API + '/api/set?tempF=' + (f ? '1' : '0'))
    .then(function() { load(); })
    .catch(function() { msg('Failed', ''); });
}

function setLoc() {
  var la = document.getElementById('lat').value;
  var lo = document.getElementById('lon').value;
  fetch(API + '/api/location', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ lat: parseFloat(la), lon: parseFloat(lo) })
  }).then(function(r) { return r.json(); })
    .then(function(d) { msg(d.message || 'Saved', d.success); })
    .catch(function() { msg('Failed', ''); });
}

// ---- System ----
function confirmReset() {
  if (confirm('Factory reset? All settings and WiFi credentials will be erased.')) {
    fetch(API + '/reset', { method: 'POST' })
      .then(function() { msg('Resetting\u2026', true); })
      .catch(function() { msg('Failed', ''); });
  }
}

// ---- OTA countdown timer ----
function otaTick() {
  otaRemaining--;
  if (otaRemaining < 0) otaRemaining = 0;
  var min = Math.floor(otaRemaining / 60);
  var sec = otaRemaining % 60;
  document.getElementById('ota-timer-text').textContent = 'Auto-rollback in ' + min + ':' + (sec < 10 ? '0' : '') + sec;
  document.getElementById('ota-timer-fill').style.width = ((120 - otaRemaining) / 120 * 100) + '%';
  if (otaRemaining <= 0) {
    stopOtaTimer();
    var tt = document.getElementById('ota-timer-text');
    tt.innerHTML = '<span id="ota-reboot-text">Rebooting\u2026 10s</span> <span class="ota-spinner"></span>';
    var rebootSec = 10;
    var ri = setInterval(function() {
      rebootSec--;
      var rt = document.getElementById('ota-reboot-text');
      if (rebootSec <= 0) { clearInterval(ri); rt.textContent = 'Redirecting\u2026'; window.location.reload(); }
      else { rt.textContent = 'Rebooting\u2026 ' + rebootSec + 's'; }
    }, 1000);
  }
}

function startOtaTimer(remaining) {
  if (otaCountdown) return;
  otaRemaining = Math.max(0, Math.floor(remaining));
  otaTick();
  otaCountdown = setInterval(otaTick, 1000);
}

function stopOtaTimer() {
  if (otaCountdown) { clearInterval(otaCountdown); otaCountdown = null; }
}

// ---- OTA confirm/rollback ----
var confirmStep = 0;
var rollbackStep = 0;

function otaConfirm() {
  var btn = document.getElementById('ota-confirm-btn');
  if (confirmStep === 0) {
    confirmStep = 1;
    btn.textContent = 'Are you sure?';
    btn.className = 'btn-sm btn-confirm are-you-sure';
    setTimeout(function() { if (confirmStep === 1) { confirmStep = 0; btn.textContent = 'Confirm Good'; btn.className = 'btn-sm btn-confirm'; } }, 4000);
    return;
  }
  confirmStep = 0;
  btn.textContent = 'Confirming\u2026';
  btn.disabled = true;
  fetch(API + '/confirm-good').then(function(r) { return r.json(); })
    .then(function(d) {
      msg('Firmware confirmed!', true);
      load();
    }).catch(function() { msg('Failed to confirm', ''); btn.textContent = 'Confirm Good'; btn.className = 'btn-sm btn-confirm'; btn.disabled = false; });
}

function otaRollback() {
  var btn = document.getElementById('ota-rollback-btn');
  if (rollbackStep === 0) {
    rollbackStep = 1;
    btn.textContent = 'Are you sure?';
    btn.className = 'btn-sm btn-rollback are-you-sure';
    setTimeout(function() { if (rollbackStep === 1) { rollbackStep = 0; btn.textContent = 'Roll Back'; btn.className = 'btn-sm btn-rollback'; } }, 4000);
    return;
  }
  rollbackStep = 0;
  btn.textContent = 'Rolling back\u2026';
  btn.disabled = true;
  fetch(API + '/rollback', { method: 'POST' })
    .then(function() { msg('Rolling back and rebooting\u2026', true); })
    .catch(function() { msg('Device is rebooting\u2026', true); });
}

// ---- Init ----
load();
</script>
</body></html>
